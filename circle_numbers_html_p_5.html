<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CircleNumbers — p5.js Preview & Real Size SVG Export</title>
  <style>
    :root {
      --gap: 12px;
      --light-bg: #f7f7f9;
      --light-card: #fff;
      --light-text: #222;
      --dark-bg: #1e1e1e;
      --dark-card: #2c2c2c;
      --dark-text: #f7f7f9;
      --transition: 0.3s;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
      margin: 0; padding: 24px;
      background: var(--light-bg);
      color: var(--light-text);
      transition: background var(--transition), color var(--transition);
    }

    body.dark {
      background: var(--dark-bg);
      color: var(--dark-text);
    }

    h1 { font-size: 20px; margin-bottom: 16px; }

    .panel { display: grid; gap: var(--gap); max-width: 940px; margin: 0 auto; }

    .card {
      background: var(--light-card);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      padding: 16px;
      transition: background var(--transition), color var(--transition);
    }

    body.dark .card {
      background: var(--dark-card);
    }

    .row { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--gap); align-items: end; }

    .field { display: grid; gap: 6px; }

    label { font-size: 12px; }

    input[type="number"] {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      transition: border var(--transition), background var(--transition);
    }

    body.dark input[type="number"] {
      background: #444;
      border: 1px solid #666;
      color: #f7f7f7;
    }

    .actions { display: flex; gap: var(--gap); flex-wrap: wrap; margin-top: 12px; }

    button {
      cursor: pointer;
      border: 0;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 600;
      background: #222;
      color: #fff;
      transition: background var(--transition), transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      background: #444;
    }

    button.secondary {
      background: #ebedf0;
      color: #111;
    }

    body.dark button.secondary {
      background: #444;
      color: #f7f7f7;
    }

    button.secondary:hover {
      background: #666;
      transform: translateY(-2px);
    }

    #previewWrap { display: grid; gap: 12px; }

    #meta { font-size: 12px; color: #555; }

    body.dark #meta { color: #aaa; }

    canvas {
      background: #fff;
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px #eee;
    }

    body.dark canvas { background: #222; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
</head>
<body>
  <div class="panel">
    <h1>CircleNumbers — Circular Number Labels (Web Preview + Real Size SVG Export)</h1>

    <div class="card">
      <div class="row">
        <div class="field">
          <label for="count">Count (integer)</label>
          <input id="count" type="number" min="1" step="1" value="320" />
        </div>
        <div class="field">
          <label for="radius">Radius (mm)</label>
          <input id="radius" type="number" min="1" step="0.1" value="200" />
        </div>
        <div class="field">
          <label for="fontSize">Font size (px)</label>
          <input id="fontSize" type="number" min="1" step="0.5" value="10" />
        </div>
        <div class="field">
          <label for="margin">Margin (mm)</label>
          <input id="margin" type="number" min="0" step="0.1" value="10" />
        </div>
      </div>

      <div class="actions">
        <button id="apply">Update Preview</button>
        <button id="saveSvg" class="secondary">Export SVG</button>
        <button id="themeToggle" class="secondary">Toggle Dark/Light Theme</button>
      </div>
    </div>

    <div class="card" id="previewWrap">
      <div id="meta">Preview is scaled to screen size. Exported SVG is real mm size.</div>
      <div id="sketch"></div>
    </div>
  </div>

  <script>
    // ===== Utilities =====
    const PX_PER_MM = 96 / 25.4;
    const mmToPx = mm => mm * PX_PER_MM;
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

    // ===== UI Elements =====
    const ui = {
      count: document.getElementById('count'),
      radius: document.getElementById('radius'),
      fontSize: document.getElementById('fontSize'),
      margin: document.getElementById('margin'),
      apply: document.getElementById('apply'),
      saveSvg: document.getElementById('saveSvg'),
      themeToggle: document.getElementById('themeToggle')
    };

    function getParams(){
      const count = Math.max(1, Math.floor(+ui.count.value || 1));
      const radiusMM = Math.max(1, +ui.radius.value || 1);
      const fontSizePX = Math.max(1, +ui.fontSize.value || 1);
      const marginMM = Math.max(0, +ui.margin.value || 0);
      return { count, radiusMM, fontSizePX, marginMM };
    }

    // ===== p5 Preview Sketch =====
    let currentSketch = null;
    function makeSketch(){
      const p = s => {
        let count, radiusMM, fontSizePX, marginMM;
        let Wpx, Hpx, scale;
        let cx, cy, radiusPx;

        s.setup = () => {
          const params = getParams();
          ({count, radiusMM, fontSizePX, marginMM} = params);

          const diameterMM = radiusMM * 2;
          const fullWpx = mmToPx(diameterMM + 2*marginMM);
          const fullHpx = fullWpx;

          const maxSide = 720;
          scale = Math.min(1, maxSide / Math.max(fullWpx, fullHpx));

          Wpx = Math.ceil(fullWpx * scale);
          Hpx = Math.ceil(fullHpx * scale);

          const cnv = s.createCanvas(Wpx, Hpx);
          cnv.parent('sketch');
          s.textAlign(s.LEFT, s.CENTER);
          s.noStroke();

          cx = Wpx/2; cy = Hpx/2;
          radiusPx = mmToPx(radiusMM) * scale;
        };

        s.draw = () => {
          s.clear();
          s.background(255);

          const params = getParams();
          const count = params.count;
          const fontMajor = params.fontSizePX * scale;
          const fontMinor = clamp((params.fontSizePX - 3), 1, 999) * scale;

          s.push();
          s.noFill();
          s.stroke(230);
          s.circle(cx, cy, radiusPx*2);
          s.pop();

          for (let i=0; i<count; i++){
            const angle = 2 * Math.PI * i / count;
            const x = cx + radiusPx * Math.cos(angle);
            const y = cy + radiusPx * Math.sin(angle);

            const isMajor = (i % 5 === 0);
            const label = isMajor ? String(i) : String(i % 10);
            s.push();
            s.translate(x, y);
            s.rotate(angle);
            s.fill(0);
            s.textSize(isMajor ? fontMajor : fontMinor);
            s.text('\u2501'+label, 0, 0);
            s.pop();
          }

          s.push();
          s.noFill();
          s.stroke(240);
          s.rect(0.5, 0.5, Wpx-1, Hpx-1, 8);
          s.pop();
        };

        s.windowResized = () => {
          s.remove();
          currentSketch = new p5(makeSketch, 'sketch');
        };
      };
      return p;
    }

    function refreshSketch(){
      if(currentSketch){ currentSketch.remove(); }
      document.getElementById('sketch').innerHTML = '';
      currentSketch = new p5(makeSketch(), 'sketch');
    }

    ui.apply.addEventListener('click', refreshSketch);

    // ===== SVG Generation =====
    function generateSVGString(){
      const {count, radiusMM, fontSizePX, marginMM} = getParams();
      const diameterMM = radiusMM * 2;
      const widthMM = diameterMM + 2*marginMM;
      const heightMM = widthMM;

      const widthPX = mmToPx(widthMM);
      const heightPX = mmToPx(heightMM);
      const cxPX = widthPX/2;
      const cyPX = heightPX/2;
      const radiusPX = mmToPx(radiusMM);
      const fontMinorPX = clamp(fontSizePX - 3, 1, 999);

      let svg = '';
      svg += `<svg xmlns="http://www.w3.org/2000/svg" width="${widthMM}mm" height="${heightMM}mm" viewBox="0 0 ${widthPX} ${heightPX}">\n`;
      svg += `  <g id="circle-numbers" font-family="Arial, Helvetica, sans-serif" text-anchor="start" dominant-baseline="middle" fill="#000">\n`;

      for(let i=0;i<count;i++){
        const angle = 2*Math.PI*i/count;
        const x = cxPX + radiusPX * Math.cos(angle);
        const y = cyPX + radiusPX * Math.sin(angle);
        const isMajor = (i % 5 === 0);
        const label = isMajor ? String(i) : String(i % 10);
        const fontSize = isMajor ? fontSizePX : fontMinorPX;
        const deg = angle * 180 / Math.PI;

        svg += `    <text font-size="${fontSize}px" transform="rotate(${deg},${x},${y})">` +
               `<tspan x="${x}" y="${y}">\u2501${escapeXml(label)}</tspan>` +
               `</text>\n`;
      }

      svg += `  </g>\n</svg>`;
      return svg;
    }

    function escapeXml(s){
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
    }

    ui.saveSvg.addEventListener('click', () => {
      const svg = generateSVGString();
      const blob = new Blob([svg], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const {count, radiusMM} = getParams();
      a.href = url;
      a.download = `CircleNumbers_r${radiusMM}mm_c${count}.svg`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    });

    // ===== Theme Toggle =====
    ui.themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    // Initial Sketch
    refreshSketch();
  </script>
</body>
</html>
